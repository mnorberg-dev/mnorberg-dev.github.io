<!doctype html>
<html
  lang="en"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="en">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  
    <title>Creating AI Processing Pipelines: A Data-First Approach &middot; Matthew Norberg&#39;s Data Engineering Blog</title>
    <meta name="title" content="Creating AI Processing Pipelines: A Data-First Approach &middot; Matthew Norberg&#39;s Data Engineering Blog">
  

  
  
    <meta name="description" content="Databricks Mosaic AI Gateway captures rich AI agent request and response data, but not in a format suitable for analysis. Turning that data into insights requires processing pipelines, and before building them, you need to understand the different shapes inference data can take. This post argues for a data-first approach that intentionally generates and examines real inference cases before designing pipelines that have to survive production.">
  
  
    <meta name="keywords" content="databricks,ai,data engineering,">
  
  
  
  <link rel="canonical" href="http://localhost:1313/posts/inference-table-processing-tests/">
  

  
  
    <meta name="author" content="Matthew Norberg">
  
  
    
      
        
          <link href="https://github.com/mnorberg-dev" rel="me">
        
      
    
      
        
          <link href="https://www.linkedin.com/in/mnorberg24/" rel="me">
        
      
    
  

  
  <meta property="og:url" content="http://localhost:1313/posts/inference-table-processing-tests/">
  <meta property="og:site_name" content="Matthew Norberg&#39;s Data Engineering Blog">
  <meta property="og:title" content="Creating AI Processing Pipelines: A Data-First Approach">
  <meta property="og:description" content="Databricks Mosaic AI Gateway captures rich AI agent request and response data, but not in a format suitable for analysis. Turning that data into insights requires processing pipelines, and before building them, you need to understand the different shapes inference data can take. This post argues for a data-first approach that intentionally generates and examines real inference cases before designing pipelines that have to survive production.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-14T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-14T00:00:00+00:00">
    <meta property="article:tag" content="Databricks">
    <meta property="article:tag" content="Ai">
    <meta property="article:tag" content="Data Engineering">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Creating AI Processing Pipelines: A Data-First Approach">
  <meta name="twitter:description" content="Databricks Mosaic AI Gateway captures rich AI agent request and response data, but not in a format suitable for analysis. Turning that data into insights requires processing pipelines, and before building them, you need to understand the different shapes inference data can take. This post argues for a data-first approach that intentionally generates and examines real inference cases before designing pipelines that have to survive production.">

  
  
  
  
    
      
    
  
    
      
    
  
    
      
    
  
  
    
  

  
  
  
  
  
  

  

  
  
  
  
  
  
  
    
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.bd563a6c669dcc9857bae6136f930de88b0447ce6590adc13d72d7e24b427918f9638fe98a575ba1aa195ce63bbf08119c6efe672dda9c4191f38cf1a22e3f3b.css"
    integrity="sha512-vVY6bGadzJhXuuYTb5MN6IsER85lkK3BPXLX4ktCeRj5Y4/pildboaoZXOY7vwgRnG7&#43;Zy3anEGR84zxoi4/Ow==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js"
    integrity="sha512-b0EXSzoFtoCCD&#43;CMrb&#43;l&#43;3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script>
  
  
  
  
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
  
    
  
  
    
  
  
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.9df4fc14d50efcc9aa4cfc2b6f348e365f421f5ad491278f8f48c0360cf2f93f08882fda6da162d7ace8e5add57c2df4ac46bd3861306b1d4c452cd31f448d64.js"
      integrity="sha512-nfT8FNUO/MmqTPwrbzSONl9CH1rUkSePj0jANgzy&#43;T8IiC/abaFi16zo5a3VfC30rEa9OGEwax1MRSzTH0SNZA=="
      data-copy="Copy"
      data-copied="Copied"></script>
  

  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>


























  

  

  

  

  





  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Creating AI Processing Pipelines: A Data-First Approach",
    "headline": "Creating AI Processing Pipelines: A Data-First Approach",
    
    "abstract": "Databricks Mosaic AI Gateway captures rich AI agent request and response data, but not in a format suitable for analysis. Turning that data into insights requires processing pipelines, and before building them, you need to understand the different shapes inference data can take. This post argues for a data-first approach that intentionally generates and examines real inference cases before designing pipelines that have to survive production.",
    "inLanguage": "en",
    "url" : "http:\/\/localhost:1313\/posts\/inference-table-processing-tests\/",
    "author" : {
      "@type": "Person",
      "name": "Matthew Norberg"
    },
    "copyrightYear": "2025",
    "dateCreated": "2025-12-14T00:00:00\u002b00:00",
    "datePublished": "2025-12-14T00:00:00\u002b00:00",
    
    "dateModified": "2025-12-14T00:00:00\u002b00:00",
    
    "keywords": ["databricks","ai","data engineering"],
    
    "mainEntityOfPage": "true",
    "wordCount": "2994"
  }]
  </script>



  
  

  
  

  
  

  
  

  
  
</head>


















  
  
  <body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        Skip to main content
      </a>
    </div>
    
    
      <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 bg-neutral dark:bg-neutral-800 z-100">
  <div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32">
    













<div
  class="main-menu flex items-center justify-between py-6 md:justify-start gap-x-3 pt-[2px] pr-2 md:pr-4 pb-[3px] pl-0">
  
  

  <div class="flex flex-1 items-center justify-between">
    <nav class="flex space-x-3">
      
        <a href="/" class="text-base font-medium">
          Matthew Norberg&rsquo;s Data Engineering Blog
        </a>
      
    </nav>
    
  <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">
    
      
        
  <a
  href="/posts/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="Blog"
  title="Posts">
  
  
    <p class="text-base font-medium">
      Blog
    </p>
  
</a>



      
        
  <a
  href="/about/"
  
  class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
  aria-label="About"
  title="About Me">
  
  
    <p class="text-base font-medium">
      About
    </p>
  
</a>



      
    

    

    

    
      <button
        id="search-button"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
      <div class=" flex items-center">
        <button
          id="appearance-switcher"
          aria-label="Dark mode switcher"
          type="button"
          class="text-base hover:text-primary-600 dark:hover:text-primary-400">
          <div class="flex items-center justify-center dark:hidden">
            <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
          </div>
          <div class="items-center justify-center hidden dark:flex">
            <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
          </div>
        </button>
      </div>
    
  </nav>

    
  <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">
    <span></span>

    

    

    
      <button
        id="search-button-mobile"
        aria-label="Search"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400"
        title="Search (/)">
        <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
      </button>
    

    
      <button
        id="appearance-switcher-mobile"
        aria-label="Dark mode switcher"
        type="button"
        class="text-base hover:text-primary-600 dark:hover:text-primary-400 me-1">
        <div class="flex items-center justify-center dark:hidden">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
        </div>
        <div class="items-center justify-center hidden dark:flex">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
        </div>
      </button>
    
  </div>

  </div>
  
  <div class="-my-2 md:hidden">
    <div id="menu-button" class="block">
      
        <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
        </div>
        <div
          id="menu-wrapper"
          class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]">
          <ul
            class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none text-end max-w-7xl">
            <li id="menu-close-button">
              <span
                class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
                <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
              </span>
            </li>

            
              
  <li class="mt-1">
  <a
    href="/posts/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="Blog"
    title="Posts">
    
    
      <p class="text-bg font-bg">
        Blog
      </p>
    
  </a>
</li>



            
              
  <li class="mt-1">
  <a
    href="/about/"
    
    class="flex items-center hover:text-primary-600 dark:hover:text-primary-400"
    aria-label="About"
    title="About Me">
    
    
      <p class="text-bg font-bg">
        About
      </p>
    
  </a>
</li>



            

          </ul>
          
        </div>
      
    </div>
  </div>

</div>





  </div>
</div>

    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Creating AI Processing Pipelines: A Data-First Approach
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  
    
  

  

  
    
  

  

  

  

  

  

  

  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2025-12-14T00:00:00&#43;00:00">14 December 2025</time>
    

    
    
  </div>

  

  
  

  
  



      </div>
      
        
  
  
  
  
  
  

  

  
    
    
<div class="flex author">
  
    
    
      
    
    
      
      
        
      
      <img
        class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4"
        width="96"
        height="96"
        alt="Matthew Norberg"
        src="/img/cover-image_hu_45e9b4d828df5a5.jpeg"
        data-zoom-src="/img/cover-image.jpeg">
    
  
  <div class="place-self-center">
    
      <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
        Author
      </div>
      <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
        Matthew Norberg
      </div>
    
    
      <div class="text-sm text-neutral-700 dark:text-neutral-400">Data engineer building AI applications, reliable pipelines, and practical tools.</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/mnorberg-dev"
          target="_blank"
          aria-label="Github"
          title="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/mnorberg24/"
          target="_blank"
          aria-label="Linkedin"
          title="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a
        >
      
    
  </div>

</div>
  </div>
</div>

  

  

  
    <div class="mb-5"></div>
  

      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]">
            
              <details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#the-inference-table-valuable-but-not-analysis-ready">The Inference Table: Valuable, but Not Analysis-Ready</a></li>
    <li><a href="#the-real-goal-a-gold-quality-inference-dataset">The Real Goal: A Gold-Quality Inference Dataset</a></li>
    <li><a href="#what-the-documentation-doesnt-emphasize">What the Documentation Doesn&rsquo;t Emphasize</a>
      <ul>
        <li><a href="#how-agent-error-handling-changes-your-data">How Agent Error Handling Changes Your Data</a></li>
      </ul>
    </li>
    <li><a href="#generating-representative-inference-outcomes">Generating Representative Inference Outcomes</a>
      <ul>
        <li><a href="#thinking-in-outcomes-not-prompts">Thinking in Outcomes, Not Prompts</a></li>
      </ul>
    </li>
    <li><a href="#the-five-inference-cases-you-should-intentionally-generate">The Five Inference Cases You Should Intentionally Generate</a></li>
    <li><a href="#why-this-matters-for-your-pipelines">Why This Matters for Your Pipelines</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#the-inference-table-valuable-but-not-analysis-ready">The Inference Table: Valuable, but Not Analysis-Ready</a></li>
    <li><a href="#the-real-goal-a-gold-quality-inference-dataset">The Real Goal: A Gold-Quality Inference Dataset</a></li>
    <li><a href="#what-the-documentation-doesnt-emphasize">What the Documentation Doesn&rsquo;t Emphasize</a>
      <ul>
        <li><a href="#how-agent-error-handling-changes-your-data">How Agent Error Handling Changes Your Data</a></li>
      </ul>
    </li>
    <li><a href="#generating-representative-inference-outcomes">Generating Representative Inference Outcomes</a>
      <ul>
        <li><a href="#thinking-in-outcomes-not-prompts">Thinking in Outcomes, Not Prompts</a></li>
      </ul>
    </li>
    <li><a href="#the-five-inference-cases-you-should-intentionally-generate">The Five Inference Cases You Should Intentionally Generate</a></li>
    <li><a href="#why-this-matters-for-your-pipelines">Why This Matters for Your Pipelines</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
  </div>
</details>


<script>
  (function () {
    'use strict'

    const SCROLL_OFFSET_RATIO = 0.33
    const TOC_SELECTOR = '#TableOfContents'
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false

    function getActiveAnchorId(anchors, offsetRatio) {
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...document.querySelectorAll('#TableOfContents a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => link.getAttribute('href').substring(1)))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      for (let i = anchors.length - 1; i >= 0; i--) {
        const top = anchors[i].getBoundingClientRect().top + window.scrollY
        if (top <= threshold && tocIds.has(anchors[i].id)) {
          return anchors[i].id
        }
      }
      return anchors.find(anchor => tocIds.has(anchor.id))?.id || ''
    }

    function updateTOC({ toc, anchors, links, scrollOffset, collapseInactive }) {
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) return

      links.forEach(link => {
        const isActive = link.getAttribute('href') === `#${activeId}`
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        let el = activeLink
        while (el && el !== toc) {
          if (el.tagName === 'UL') el.style.display = ''
          if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
          el = el.parentElement
        }
      }
    }

    function initTOC() {
      const toc = document.querySelector(TOC_SELECTOR)
      if (!toc) return

      const collapseInactive = true
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
        })
      })

      const config = {
        toc,
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      window.addEventListener('scroll', () => updateTOC(config), { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      updateTOC(config)
    }

    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', initTOC)
      : initTOC()
  })()
</script>


            
          </div>
        </div>
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          <!-- Enables word wrapping in code cell blocks for this article only -->
<style>
  .article-content pre {
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: anywhere;
  }
  .article-content pre code {
    white-space: pre-wrap;
  }
</style>
<p>When you deploy an AI agent in Databricks using the Mosaic AI Gateway, one very nice thing happens automatically: every request to your agent, along with the corresponding response, is logged for you. These records are stored in what Databricks refers to as an inference table.</p>
<p>At first glance, it feels like you’ve achieved agent observability. Each request and response is stored for you by default, without the developer needing to write any additional logging code.</p>
<p>In reality, having the data and being able to use it are very different things. Turning inference table data into something you can reliably analyze means building additional processing pipelines to extract, normalize, and structure the data.</p>
<p>However, adding more pipelines also increases the complexity of your data stack. Each new step introduces assumptions about how the model behaves and what the data will look like, and those assumptions need to hold up in production.</p>
<p>This is where many data teams run into trouble. Processing pipelines are often designed for how the model is expected to behave, without considering the full range of outcomes. Only later do differences in response structure, failure modes, and streaming behavior start to surface—often after those pipelines are already in use.</p>
<p>This post takes a data-first approach to building AI processing pipelines. Rather than focusing on implementation, it examines how inference data varies in practice, how agent behavior shapes what gets recorded in the inference table, and which inference outcomes you should intentionally generate so downstream pipelines can handle real-world variability from the start.</p>

<h2 class="relative group">The Inference Table: Valuable, but Not Analysis-Ready
    <div id="the-inference-table-valuable-but-not-analysis-ready" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#the-inference-table-valuable-but-not-analysis-ready" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>The inference table stores each request and its corresponding response in the <code>request</code> and <code>response</code> columns. Both are stored as strings containing deeply nested JSON.</p>
<p>Inside those JSON blobs is everything you might want to analyze:</p>
<ul>
<li>Input, completion, and total token counts</li>
<li>Prompt and content filter results (especially relevant with Azure OpenAI)</li>
<li>User or caller identity</li>
<li>Error information</li>
<li>MLflow tracing metadata</li>
</ul>
<p>The inference table captures all of this data, but it isn’t structured for answering questions. As soon as you start asking things like how many tokens are being consumed, which requests are triggering safety or content filters, or why certain requests failed, you quickly realize that the inference table is a logging table, not an analytics table. It’s optimized for completeness, not usability.</p>
<p>Here’s a simplified example of what a single <code>response</code> value can look like in the inference table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;object&#34;</span><span class="p">:</span> <span class="s2">&#34;response&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;output&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;Absolutely! Here\u2019s a classic, crowd-pleasing **Apple Pie Recipe** perfect for Thanksgiving. It features a flaky crust and ... &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;output_text&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;assistant&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;databricks_output&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;trace&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;client_request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;MLFLOW_EXPERIMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow_experiment&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;experiment_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;request_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-12-02T16:52:20.818Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.modelId&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.trace_schema.version&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.trace.tokenUsage&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;input_tokens\&#34;: 27, \&#34;output_tokens\&#34;: 641, \&#34;total_tokens\&#34;: 668}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.databricks.modelServingEndpointName&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;app_version_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;is_truncated&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;request_preview&#34;</span><span class="p">:</span> <span class="s2">&#34;What is a good apple pie recipe to use on Thanksgiving&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;response_preview&#34;</span><span class="p">:</span> <span class="s2">&#34;Absolutely! Here\u2019s a classic, crowd-pleasing **Apple Pie Recipe** perfect for Thanksgiving. It features a flaky crust and ... &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;execution_duration_ms&#34;</span><span class="p">:</span> <span class="mi">5098</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;spans&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;parent_span_id&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;predict&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;start_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1764694340818061307</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;end_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1764694345916778373</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;STATUS_CODE_OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.traceRequestId&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanType&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;AGENT\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanFunctionName&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;predict\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanInputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;request\&#34;: {\&#34;tool_choice\&#34;: null, \&#34;truncation\&#34;: null, \&#34;max_output_tokens\&#34;: null, \&#34;metadata\&#34;: null, \&#34;parallel_tool_calls\&#34;: null, \&#34;tools\&#34;: null, \&#34;reasoning\&#34;: null, \&#34;store\&#34;: null, \&#34;stream\&#34;: null, \&#34;temperature\&#34;: null, \&#34;text\&#34;: null, \&#34;top_p\&#34;: null, \&#34;user\&#34;: null, \&#34;input\&#34;: [{\&#34;status\&#34;: null, \&#34;content\&#34;: \&#34;You are a helpful assistant\&#34;, \&#34;role\&#34;: \&#34;system\&#34;, \&#34;type\&#34;: \&#34;message\&#34;}, {\&#34;status\&#34;: null, \&#34;content\&#34;: \&#34;What is a good apple pie recipe to use on Thanksgiving\&#34;, \&#34;role\&#34;: \&#34;user\&#34;, \&#34;type\&#34;: \&#34;message\&#34;}], \&#34;custom_inputs\&#34;: null, \&#34;context\&#34;: null}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanOutputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;tool_choice\&#34;: null, \&#34;truncation\&#34;: null, \&#34;id\&#34;: null, \&#34;created_at\&#34;: null, \&#34;error\&#34;: null, \&#34;incomplete_details\&#34;: null, \&#34;instructions\&#34;: null, \&#34;metadata\&#34;: null, \&#34;model\&#34;: null, \&#34;object\&#34;: \&#34;response\&#34;, \&#34;output\&#34;: [{\&#34;type\&#34;: \&#34;message\&#34;, \&#34;id\&#34;: \&#34;&lt;redacted&gt;\&#34;, \&#34;content\&#34;: [{\&#34;text\&#34;: \&#34;Absolutely! Here\u2019s a classic, crowd-pleasing **Apple Pie Recipe** perfect for Thanksgiving. It features a flaky crust and ... \&#34;, \&#34;type\&#34;: \&#34;output_text\&#34;}], \&#34;role\&#34;: \&#34;assistant\&#34;}], \&#34;parallel_tool_calls\&#34;: null, \&#34;temperature\&#34;: null, \&#34;tools\&#34;: null, \&#34;top_p\&#34;: null, \&#34;max_output_tokens\&#34;: null, \&#34;previous_response_id\&#34;: null, \&#34;reasoning\&#34;: null, \&#34;status\&#34;: null, \&#34;text\&#34;: null, \&#34;usage\&#34;: null, \&#34;user\&#34;: null, \&#34;custom_outputs\&#34;: null}&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;parent_span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Completions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;start_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1764694340819104621</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;end_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1764694345916576447</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;STATUS_CODE_OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.traceRequestId&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanType&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;CHAT_MODEL\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanInputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;model\&#34;: \&#34;&lt;redacted&gt;\&#34;, \&#34;messages\&#34;: [{\&#34;content\&#34;: \&#34;You are a helpful assistant\&#34;, \&#34;role\&#34;: \&#34;system\&#34;}, {\&#34;content\&#34;: \&#34;What is a good apple pie recipe to use on Thanksgiving\&#34;, \&#34;role\&#34;: \&#34;user\&#34;}], \&#34;temperature\&#34;: 0.5, \&#34;max_completion_tokens\&#34;: null, \&#34;stream\&#34;: false}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;model&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;0.5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;max_completion_tokens&#34;</span><span class="p">:</span> <span class="s2">&#34;null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;stream&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.message.format&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;openai\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.chat.tokenUsage&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;input_tokens\&#34;: 27, \&#34;output_tokens\&#34;: 641, \&#34;total_tokens\&#34;: 668}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanOutputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;id\&#34;: \&#34;&lt;redacted&gt;\&#34;, \&#34;choices\&#34;: [{\&#34;finish_reason\&#34;: \&#34;stop\&#34;, \&#34;index\&#34;: 0, \&#34;logprobs\&#34;: null, \&#34;message\&#34;: {\&#34;content\&#34;: \&#34;Absolutely! Here\u2019s a classic, crowd-pleasing **Apple Pie Recipe** perfect for Thanksgiving. It features a flaky crust and ... \&#34;, \&#34;refusal\&#34;: null, \&#34;role\&#34;: \&#34;assistant\&#34;, \&#34;annotations\&#34;: [], \&#34;audio\&#34;: null, \&#34;function_call\&#34;: null, \&#34;tool_calls\&#34;: null}, \&#34;content_filter_results\&#34;: {\&#34;hate\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;protected_material_code\&#34;: {\&#34;filtered\&#34;: false, \&#34;detected\&#34;: false}, \&#34;protected_material_text\&#34;: {\&#34;filtered\&#34;: false, \&#34;detected\&#34;: false}, \&#34;self_harm\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;sexual\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;violence\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}}}], \&#34;created\&#34;: 1764694340, \&#34;model\&#34;: \&#34;gpt-4.1-2025-04-14\&#34;, \&#34;object\&#34;: \&#34;chat.completion\&#34;, \&#34;service_tier\&#34;: null, \&#34;system_fingerprint\&#34;: \&#34;fp_f99638a8d7\&#34;, \&#34;usage\&#34;: {\&#34;completion_tokens\&#34;: 641, \&#34;prompt_tokens\&#34;: 27, \&#34;total_tokens\&#34;: 668, \&#34;completion_tokens_details\&#34;: {\&#34;accepted_prediction_tokens\&#34;: 0, \&#34;audio_tokens\&#34;: 0, \&#34;reasoning_tokens\&#34;: 0, \&#34;rejected_prediction_tokens\&#34;: 0}, \&#34;prompt_tokens_details\&#34;: {\&#34;audio_tokens\&#34;: 0, \&#34;cached_tokens\&#34;: 0}}, \&#34;prompt_filter_results\&#34;: [{\&#34;prompt_index\&#34;: 0, \&#34;content_filter_results\&#34;: {\&#34;hate\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;jailbreak\&#34;: {\&#34;filtered\&#34;: false, \&#34;detected\&#34;: false}, \&#34;self_harm\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;sexual\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}, \&#34;violence\&#34;: {\&#34;filtered\&#34;: false, \&#34;severity\&#34;: \&#34;safe\&#34;}}}]}&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;databricks_request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>Note:</strong> IDs are redacted and the assistant output is truncated for readability. This example comes from a <code>predict</code> request. Streaming responses (<code>predict_stream</code>) are typically larger and harder to present cleanly in a blog post.</p>
<p>Code blocks are also line-wrapped in this post so it’s easier to see the full paths and values, even though it makes the JSON look a little less neat.</p>
</blockquote>
<p>For data engineers, this usually means building a data pipeline that extracts and normalizes these values into well-typed columns. Those tables can then be wired up to tools like Genie, which uses an LLM to answer questions over the data, or surfaced through downstream analytic dashboards.</p>

<h2 class="relative group">The Real Goal: A Gold-Quality Inference Dataset
    <div id="the-real-goal-a-gold-quality-inference-dataset" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#the-real-goal-a-gold-quality-inference-dataset" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>What we ultimately want is straightforward:</p>
<ul>
<li>One row per logical request</li>
<li>Stable, well-typed columns</li>
<li>Easy aggregation and filtering</li>
</ul>
<p>More concretely, this means pulling the most important fields from the raw <code>request</code> and <code>response</code> JSON and promoting them to first-class columns. In general, any values that you expect to analyze later should be extracted and stored with well-defined data types, rather than remaining buried inside large JSON strings.</p>
<p>Token usage is a good example. While token counts can be extracted from a JSON string at query time, doing so leads to long, noisy queries that are hard to read and reason about. It is far cleaner to extract values like input tokens, output tokens, and total tokens from the response JSON and store them as well-typed numeric columns, making them easy to filter, aggregate, and monitor over time.</p>
<p>Once you have this kind of structure in place, everything opens up. You can analyze usage patterns, identify risky or inappropriate requests, monitor token spend, and use real data to improve your agent.</p>
<p>But there’s a catch that isn’t obvious at first.</p>
<p>You can’t design processing pipelines that produce gold-quality tables to be both correct and resilient until you understand every shape your inference data can take.</p>

<h2 class="relative group">What the Documentation Doesn&rsquo;t Emphasize
    <div id="what-the-documentation-doesnt-emphasize" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#what-the-documentation-doesnt-emphasize" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>One of the lessons I learned the hard way is that the JSON written to the <code>response</code> column is not a fixed shape</p>
<p>In practice, it varies based on three factors:</p>
<ol>
<li>Which inference endpoint is called (<code>predict</code> or <code>predict_stream</code>)</li>
<li>Whether the underlying model throws an error</li>
<li>How your agent code handles that error, if one occurs</li>
</ol>
<p>The first distinction is easy to overlook. A request made to <code>predict</code> returns a single response, while a request made to <code>predict_stream</code> returns content incrementally. As a result, the JSON written to the <code>response</code> column has a different shape depending on which endpoint is used.</p>
<p>The second and third factors are related but distinct. Whether the model throws an error indicates that something went wrong. How your agent handles that error determines what gets recorded in the inference table.</p>
<p>Here’s a concrete example of how the <code>response</code> JSON can differ for a request made to the <code>predict</code> endpoint when the underlying model throws an error:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;object&#34;</span><span class="p">:</span> <span class="s2">&#34;response&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;output&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;message&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;flagged&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;This question has been flagged as inappropriate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;output_text&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;assistant&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;databricks_output&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;trace&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;info&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;client_request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;MLFLOW_EXPERIMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow_experiment&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;experiment_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;request_time&#34;</span><span class="p">:</span> <span class="s2">&#34;2025-12-17T20:45:43.536Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;trace_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.databricks.modelServingEndpointName&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.trace_schema.version&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;mlflow.modelId&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;app_version_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;is_truncated&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;request_preview&#34;</span><span class="p">:</span> <span class="s2">&#34;How do I rob a bank without getting caught?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;response_preview&#34;</span><span class="p">:</span> <span class="s2">&#34;This question has been flagged as inappropriate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;execution_duration_ms&#34;</span><span class="p">:</span> <span class="mi">464</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;spans&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;parent_span_id&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;predict&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;start_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1766004343536444701</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;end_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1766004344000597938</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;STATUS_CODE_OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.traceRequestId&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanType&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;AGENT\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanFunctionName&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;predict\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanInputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;request\&#34;: {\&#34;tool_choice\&#34;: null, \&#34;truncation\&#34;: null, \&#34;max_output_tokens\&#34;: null, \&#34;metadata\&#34;: null, \&#34;parallel_tool_calls\&#34;: null, \&#34;tools\&#34;: null, \&#34;reasoning\&#34;: null, \&#34;store\&#34;: null, \&#34;stream\&#34;: null, \&#34;temperature\&#34;: null, \&#34;text\&#34;: null, \&#34;top_p\&#34;: null, \&#34;user\&#34;: null, \&#34;input\&#34;: [{\&#34;status\&#34;: null, \&#34;content\&#34;: \&#34;You are a helpful assistant\&#34;, \&#34;role\&#34;: \&#34;system\&#34;, \&#34;type\&#34;: \&#34;message\&#34;}, {\&#34;status\&#34;: null, \&#34;content\&#34;: \&#34;How do I rob a bank without getting caught?\&#34;, \&#34;role\&#34;: \&#34;user\&#34;, \&#34;type\&#34;: \&#34;message\&#34;}], \&#34;custom_inputs\&#34;: null, \&#34;context\&#34;: null}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanOutputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;tool_choice\&#34;: null, \&#34;truncation\&#34;: null, \&#34;id\&#34;: null, \&#34;created_at\&#34;: null, \&#34;error\&#34;: null, \&#34;incomplete_details\&#34;: null, \&#34;instructions\&#34;: null, \&#34;metadata\&#34;: null, \&#34;model\&#34;: null, \&#34;object\&#34;: \&#34;response\&#34;, \&#34;output\&#34;: [{\&#34;type\&#34;: \&#34;message\&#34;, \&#34;id\&#34;: \&#34;flagged\&#34;, \&#34;content\&#34;: [{\&#34;text\&#34;: \&#34;This question has been flagged as inappropriate\&#34;, \&#34;type\&#34;: \&#34;output_text\&#34;}], \&#34;role\&#34;: \&#34;assistant\&#34;}], \&#34;parallel_tool_calls\&#34;: null, \&#34;temperature\&#34;: null, \&#34;tools\&#34;: null, \&#34;top_p\&#34;: null, \&#34;max_output_tokens\&#34;: null, \&#34;previous_response_id\&#34;: null, \&#34;reasoning\&#34;: null, \&#34;status\&#34;: null, \&#34;text\&#34;: null, \&#34;usage\&#34;: null, \&#34;user\&#34;: null, \&#34;custom_outputs\&#34;: null}&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;trace_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;parent_span_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Completions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;start_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1766004343537162020</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;end_time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1766004344000358635</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;exception&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;time_unix_nano&#34;</span><span class="p">:</span> <span class="mi">1766004344000273</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;exception.message&#34;</span><span class="p">:</span> <span class="s2">&#34;Error code: 400 - {&#39;error_code&#39;: &#39;BAD_REQUEST&#39;, &#39;message&#39;: &#39;{\&#34;external_model_provider\&#34;:\&#34;openai\&#34;,\&#34;external_model_error\&#34;:{\&#34;error\&#34;:{\&#34;param\&#34;:\&#34;prompt\&#34;,\&#34;code\&#34;:\&#34;content_filter\&#34;,\&#34;innererror\&#34;:{\&#34;code\&#34;:\&#34;ResponsibleAIPolicyViolation\&#34;,\&#34;content_filter_result\&#34;:{\&#34;jailbreak\&#34;:{\&#34;filtered\&#34;:false,\&#34;detected\&#34;:false},\&#34;violence\&#34;:{\&#34;filtered\&#34;:true,\&#34;severity\&#34;:\&#34;medium\&#34;},\&#34;sexual\&#34;:{\&#34;filtered\&#34;:false,\&#34;severity\&#34;:\&#34;safe\&#34;},\&#34;hate\&#34;:{\&#34;filtered\&#34;:false,\&#34;severity\&#34;:\&#34;safe\&#34;},\&#34;self_harm\&#34;:{\&#34;filtered\&#34;:false,\&#34;severity\&#34;:\&#34;safe\&#34;}}},\&#34;status\&#34;:400,\&#34;message\&#34;:\&#34;The response was filtered due to the prompt triggering Azure OpenAI\\&#39;s content management policy. Please modify your prompt and retry. To learn more about our content filtering policies please read our documentation: https://go.microsoft.com/fwlink/?linkid=2198766\&#34;,\&#34;type\&#34;:null}}}&#39;}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;exception.type&#34;</span><span class="p">:</span> <span class="s2">&#34;BadRequestError&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nt">&#34;exception.stacktrace&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;STATUS_CODE_ERROR&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.traceRequestId&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanType&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;CHAT_MODEL\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.spanInputs&#34;</span><span class="p">:</span> <span class="s2">&#34;{\&#34;model\&#34;: \&#34;&lt;redacted&gt;\&#34;, \&#34;messages\&#34;: [{\&#34;content\&#34;: \&#34;You are a helpful assistant\&#34;, \&#34;role\&#34;: \&#34;system\&#34;}, {\&#34;content\&#34;: \&#34;How do I rob a bank without getting caught?\&#34;, \&#34;role\&#34;: \&#34;user\&#34;}], \&#34;temperature\&#34;: 0.5, \&#34;max_completion_tokens\&#34;: null, \&#34;stream\&#34;: false}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;model&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;&lt;redacted&gt;\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;0.5&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;max_completion_tokens&#34;</span><span class="p">:</span> <span class="s2">&#34;null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;stream&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="nt">&#34;mlflow.message.format&#34;</span><span class="p">:</span> <span class="s2">&#34;\&#34;openai\&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;databricks_request_id&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;redacted&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Compare this error response to the successful example in the previous section. The table columns are the same, but the JSON shape inside <code>response</code> changes in ways your processing pipelines need to account for.</p>
<p>Let’s take a closer look at the two JSON blocks. Even though both come from calls to the same endpoint, you’ll see that some of the information you’ll want to extract appears in different locations. For example, prompt filter results and content filter results don’t show up at the same path in each block, even though they’re exactly the kinds of fields you’ll want to analyze and normalize.</p>
<blockquote>
<p><strong>Note:</strong> The extraction challenge isn’t only that fields move around. Many of the interesting values are stored as strings containing escaped JSON, so you end up parsing JSON, then parsing JSON again inside it.</p>
</blockquote>
<p>That matters because it affects how you write your extraction logic. If you assume the filter results always appear where they do in the successful response, pipelines that extract prompt and content filter information will either return nulls when those fields aren’t actually null, or throw errors, depending on how your code is written.</p>

<h3 class="relative group">How Agent Error Handling Changes Your Data
    <div id="how-agent-error-handling-changes-your-data" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#how-agent-error-handling-changes-your-data" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>In early versions of my AI chat agent, the code did not explicitly handle model errors. When the underlying model rejected a request, the error information was simply passed along to the next layer in the stack. From a control-flow perspective, this worked fine.</p>
<p>From a data perspective, it didn’t.</p>
<p>The inference rows associated with these failures contained very little information. Important metadata that we later wanted to analyze was missing from the <code>response</code> column.</p>
<p>Eventually, the agent was updated to catch these errors and return a custom message downstream. While this didn’t change the fact that the request failed, it had a significant impact on the data captured in the inference table. The <code>response</code> column now contained much richer information that had been missing in the earlier implementation.</p>
<p>The key point isn’t how you handle errors in your agent. It’s that agent implementation choices directly affect the structure and completeness of your inference data.</p>

<h2 class="relative group">Generating Representative Inference Outcomes
    <div id="generating-representative-inference-outcomes" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#generating-representative-inference-outcomes" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>Up to this point, we’ve focused on why inference data varies. The endpoint you call (<code>predict</code> vs <code>predict_stream</code>), whether a request succeeds or fails, and how your agent handles errors all influence what gets recorded in the inference table.</p>
<p>The next step is to send deliberately varied requests, not because you care about the answers, but because you care about the inference rows they produce. This often feels like you’re testing the model. However, unlike true model testing, you’re not doing this to judge response quality. The goal is to capture the range of inference outcomes your pipeline must handle.</p>
<p>In practical terms, you’re trying to populate the inference table with representative cases: successful requests, blocked requests, streamed responses, partially streamed responses, and everything in between. Once those cases exist, you can design your pipelines with confidence, because they’ve been exercised against real variability rather than idealized assumptions.</p>

<h3 class="relative group">Thinking in Outcomes, Not Prompts
    <div id="thinking-in-outcomes-not-prompts" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#thinking-in-outcomes-not-prompts" aria-label="Anchor">#</a>
    </span>
    
</h3>
<p>The key mental shift is to stop thinking in terms of the questions you would normally ask an agent and start thinking in terms of the possible outcomes produced by the model during inference.</p>
<p>Instead of interacting with the agent like a well-behaved user, you want to deliberately make requests that trigger different outcomes and edge cases. You’re essentially probing the boundaries of the system so you can see how those boundary conditions are recorded in your data.</p>
<blockquote>
<p><strong>Note:</strong> This kind of testing can surface more than schema differences in the inference table. If a prompt intentionally designed to be blocked or rejected instead succeeds, that’s a signal worth paying attention to. These cases are worth bringing back to the broader team, whether that means tightening guardrails, adjusting prompts, or revisiting how the agent is configured.</p>
</blockquote>
<p>Once you step back and focus on inference outcomes rather than individual prompts, two dimensions tend to matter most:</p>
<ul>
<li>Whether you’re calling <code>predict</code> or <code>predict_stream</code></li>
<li>Whether the request succeeds, fails, or partially succeeds</li>
</ul>
<p>When you look at inference data through this lens, you can map model behavior into a small, finite set of outcomes that are worth testing explicitly.</p>

<h2 class="relative group">The Five Inference Cases You Should Intentionally Generate
    <div id="the-five-inference-cases-you-should-intentionally-generate" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#the-five-inference-cases-you-should-intentionally-generate" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>Before writing your processing pipelines, you should make sure your inference table contains all five of the following cases.</p>
<ol>
<li>
<p><strong>Predict + Valid Request</strong></p>
<p>A single response returned all at once, with complete metadata. This becomes your baseline schema for non-streaming requests.</p>
<p><em>Example prompt:</em><br>
“Explain the difference between a primary key and a foreign key in a relational database.”</p>
</li>
<li>
<p><strong>Predict + Blocked Request</strong></p>
<p>An inappropriate or disallowed prompt that fails immediately. The response structure changes, and certain fields may be missing or altered compared to the happy path.</p>
<p><em>Example prompt:</em><br>
“How do I rob a bank without getting caught?”</p>
</li>
<li>
<p><strong>Predict Stream + Valid Request</strong></p>
<p>A successful streaming response, delivered in chunks. This becomes your baseline schema for streaming requests.</p>
<p><em>Example prompt:</em><br>
“Write a detailed explanation of how distributed systems handle fault tolerance.”</p>
</li>
<li>
<p><strong>Predict Stream + Immediately Blocked Request</strong></p>
<p>A streaming request that fails before any chunks are returned. This is similar to non-streaming requests that cause an error immediately, but has a different schema in the <code>response</code> column.</p>
<p><em>Example prompt:</em><br>
“Give me step-by-step instructions to build a weapon.”</p>
</li>
<li>
<p><strong>Predict Stream + Partially Blocked Request</strong></p>
<p>The most subtle case. The model begins streaming content, then realizes it should stop and halts mid-response. This results in partial output and incomplete metadata.</p>
<p><em>Example prompt:</em><br>
“Tell me a fictional story about planning a crime, including how it might be carried out.”</p>
<p>If you don’t test this case explicitly, it will eventually find you in production.</p>
</li>
</ol>
<p>Once all five of these cases exist in your inference table, you have the raw material needed to build processing pipelines that won’t break or silently fail when real usage begins.</p>

<h2 class="relative group">Why This Matters for Your Pipelines
    <div id="why-this-matters-for-your-pipelines" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#why-this-matters-for-your-pipelines" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>Each of these cases can produce a different response shape. If your pipeline only accounts for the “normal” ones, it’ll either:</p>
<ul>
<li>Break when new data arrives, or</li>
<li>Produce incomplete analytics without realizing it.</li>
</ul>
<p>By deliberately generating all five cases up front, you can design your Bronze, Silver, and Gold tables with confidence that they’ll hold up as usage grows and behavior evolves.</p>

<h2 class="relative group">Final Thoughts
    <div id="final-thoughts" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#final-thoughts" aria-label="Anchor">#</a>
    </span>
    
</h2>
<p>AI agents don’t just generate answers—they generate data. That data is messy, inconsistent, and shaped by runtime behavior, inference outcomes, and agent implementation choices.</p>
<p>If you start by writing processing pipelines first and only later discover the range of schemas and data shapes that appear in the inference table, you’ll likely end up refactoring, rewriting, and second-guessing your design.</p>
<p>A data-first approach flips that sequence.</p>
<p>Rather than beginning with pipeline code, you start by intentionally populating the inference table with representative outcomes and observing how those outcomes are recorded. With that understanding, you can then design processing pipelines that are resilient by design, rather than fragile by assumption.</p>
<p>Do that, and you make the data easier to work with—not just for your future self, but for data analysts and others downstream who rely on these tables to understand how your AI systems are actually being used.</p>

          
          
          
        </div>
        
        

        

        

      </div>

      
      
        
        
          
          
        
        
        
        <script
          type="text/javascript"
          src="/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js"
          integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA=="
          data-oid="views_posts/databricks-ai-inference-pipeline-testing/index.md"
          data-oid-likes="likes_posts/databricks-ai-inference-pipeline-testing/index.md"></script>
      
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      

      
    </footer>
  </article>

        


  






<div
  id="scroll-to-top"
  class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200">
  <a
    href="#the-top"
    class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top"
    title="Scroll to top">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">
    
    
      <p class="text-sm text-neutral-500 dark:text-neutral-400">
          &copy;
          2025
          Matthew Norberg
      </p>
    

    
    
      <p class="text-xs text-neutral-500 dark:text-neutral-400">
        
        
        Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
      </p>
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
  <script
    type="text/javascript"
    src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js"
    integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="http://localhost:1313/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
